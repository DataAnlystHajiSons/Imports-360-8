<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shipment Details Submission - Imports 360</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .form-container {
      background-color: #ffffff;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
      width: 100%;
      max-width: 650px;
      position: relative;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .logo {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
    }

    .logo i {
      color: white;
      font-size: 2rem;
    }

    .header h1 {
      color: #1e293b;
      margin-bottom: 10px;
      font-size: 1.875rem;
      font-weight: 700;
    }

    .header p {
      color: #64748b;
      font-size: 1rem;
      line-height: 1.5;
    }

    .form-group {
      margin-bottom: 24px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #334155;
      font-size: 0.875rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1rem;
      color: #475569;
      transition: all 0.3s ease;
      background-color: #f8fafc;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      background-color: #ffffff;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .dimensions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .dimensions-grid .form-group {
      margin-bottom: 0;
    }

    .section-header {
      color: #1e293b;
      margin: 40px 0 24px 0;
      padding-bottom: 12px;
      border-bottom: 2px solid #e2e8f0;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.125rem;
      font-weight: 600;
    }

    .section-header i {
      color: #667eea;
      font-size: 1.25rem;
    }

    .required {
      color: #dc2626;
    }

    .form-hint {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-top: 4px;
      font-style: italic;
    }

    .button-submit {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .button-submit:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
    }

    .button-submit:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .message {
      padding: 16px 20px;
      border-radius: 10px;
      margin: 20px 0;
      text-align: center;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .success-message {
      background-color: #dcfce7;
      color: #166534;
      border: 2px solid #22c55e;
    }

    .error-message {
      background-color: #fee2e2;
      color: #dc2626;
      border: 2px solid #ef4444;
    }

    .warning-message {
      background-color: #fef3c7;
      color: #d97706;
      border: 2px solid #f59e0b;
    }

    .form-disabled {
      opacity: 0.6;
      pointer-events: none;
    }

    .submitted-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px;
    }

    .submitted-overlay .checkmark {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }

    .submitted-overlay .checkmark i {
      color: white;
      font-size: 2.5rem;
    }

    .submitted-overlay h2 {
      color: #166534;
      margin-bottom: 10px;
      font-size: 1.5rem;
    }

    .submitted-overlay p {
      color: #64748b;
      line-height: 1.5;
    }

    @media (max-width: 640px) {
      .form-container {
        padding: 30px 20px;
        margin: 10px;
      }
      
      .dimensions-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .header h1 {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="form-container" id="formContainer">
    <div class="header">
      <div class="logo">
        <i class="fas fa-shipping-fast"></i>
      </div>
      <h1>Shipment Details Form</h1>
      <p>Please fill in the details below</p>
    </div>

    <div id="form-message" class="message" style="display: none;"></div>
    
    <form id="shipment-details-form">
      <input type="hidden" id="shipment_id" name="shipment_id">

      <h3 class="section-header">
        <i class="fas fa-calendar-alt"></i>
        Shipment Information
      </h3>

      <div class="form-group">
        <label for="readiness_date">Readiness Date <span class="required">*</span></label>
        <input type="date" id="readiness_date" name="readiness_date" required>
        <div class="form-hint">When will the shipment be ready?</div>
      </div>

      <div class="form-group">
        <label for="address">Pickup Address <span class="required">*</span></label>
        <textarea id="address" name="address" rows="2" placeholder="Full address for collection" required></textarea>
      </div>

      <div class="form-group">
        <label for="origin">Country of Origin <span class="required">*</span></label>
        <input type="text" id="origin" name="origin" placeholder="e.g., Pakistan" required>
      </div>

      <h3 class="section-header">
        <i class="fas fa-truck"></i>
        Transport & Terms
      </h3>

      <div class="form-group">
        <label for="transport">Transport Mode <span class="required">*</span></label>
        <select id="transport" name="transport" required>
          <option value="">Select Transport Mode</option>
          <option value="air">‚úàÔ∏è Air Freight</option>
          <option value="sea">üö¢ Sea Freight</option>
          <option value="road">üöõ Road Transport</option>
          <option value="rail">üöÇ Rail Transport</option>
        </select>
      </div>

      <div class="form-group">
        <label for="inco_terms">Incoterms <span class="required">*</span></label>
        <select id="inco_terms" name="inco_terms" required disabled>
          <option value="">Select transport mode first</option>
        </select>
        <div class="form-hint">Select transport mode to enable</div>
      </div>

      <h3 class="section-header">
        <i class="fas fa-weight"></i>
        Package Details
      </h3>

      <div class="form-group">
        <label for="container_type">Container Type <span class="required">*</span></label>
        <select id="container_type" name="container_type" required>
          <option value="">Select Type</option>
          <option value="carton">üì¶ Carton</option>
          <option value="pallet">üèóÔ∏è Pallet</option>
        </select>
      </div>

      <div class="form-group">
        <label for="cartons_count">Number of Units <span class="required">*</span></label>
        <input type="number" id="cartons_count" name="cartons_count" min="1" placeholder="Total count" required>
      </div>

      <div class="form-group">
        <label for="gross_weight">Gross Weight (kg) <span class="required">*</span></label>
        <input type="number" step="0.01" id="gross_weight" name="gross_weight" placeholder="With packaging" required min="0">
      </div>

      <div class="form-group">
        <label for="net_weight">Net Weight (kg) <span class="required">*</span></label>
        <input type="number" step="0.01" id="net_weight" name="net_weight" placeholder="Without packaging" required min="0">
      </div>

      <h3 class="section-header">
        <i class="fas fa-cube"></i>
        Dimensions (Optional)
      </h3>
      
      <div class="dimensions-grid">
        <div class="form-group">
          <label for="length">Length (cm)</label>
          <input type="number" step="0.01" id="length" name="length" placeholder="0.00" min="0">
        </div>

        <div class="form-group">
          <label for="width">Width (cm)</label>
          <input type="number" step="0.01" id="width" name="width" placeholder="0.00" min="0">
        </div>

        <div class="form-group">
          <label for="height">Height (cm)</label>
          <input type="number" step="0.01" id="height" name="height" placeholder="0.00" min="0">
        </div>
      </div>

      <button type="submit" class="button-submit" id="submitButton">
        <i class="fas fa-paper-plane"></i>
        Submit Shipment Details
      </button>
    </form>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.4/+esm";
    const supabase = createClient("https://sfknzqkiqxivzcualcau.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNma256cWtpcXhpdnpjdWFsY2F1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3OTU0ODksImV4cCI6MjA3MjM3MTQ4OX0.JKjOS9NRdbVH1UanfqmBeHmMSnlWlZtDr-5LdKw5YaA");

    const form = document.getElementById('shipment-details-form');
    const messageDiv = document.getElementById('form-message');
    const shipmentIdInput = document.getElementById('shipment_id');
    const formContainer = document.getElementById('formContainer');

    function showMessage(message, type = 'success') {
      messageDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'exclamation-triangle'}"></i>
        ${message}
      `;
      messageDiv.className = `message ${type}-message`;
      messageDiv.style.display = 'flex';
      
      // Auto-hide success messages after 5 seconds
      if (type === 'success') {
        setTimeout(() => {
          messageDiv.style.display = 'none';
        }, 5000);
      }
    }

    function showSubmittedOverlay() {
      const overlay = document.createElement('div');
      overlay.className = 'submitted-overlay';
      overlay.innerHTML = `
        <div class="checkmark">
          <i class="fas fa-check"></i>
        </div>
        <h2>Details Submitted Successfully!</h2>
        <p>Thank you for providing the shipment details. Your information has been received and will be processed accordingly.</p>
        <p style="margin-top: 15px; font-size: 0.9rem; color: #94a3b8;">You can now close this page.</p>
      `;
      formContainer.appendChild(overlay);
    }

    // Dynamic Incoterms population based on transport mode
    const transportSelect = document.getElementById('transport');
    const incoTermsSelect = document.getElementById('inco_terms');

    const incotermsOptions = {
      'sea': ['EXW', 'FOB', 'CFR', 'DDP'],
      'air': ['EXW', 'FCA', 'CPT', 'DDP'],
      'road': ['EXW', 'FCA', 'CPT', 'DDP'],
      'rail': ['EXW', 'FCA', 'CPT', 'DDP']
    };

    transportSelect.addEventListener('change', function() {
      const selectedMode = this.value;
      
      // Clear and reset incoterms dropdown
      incoTermsSelect.innerHTML = '<option value="">Select Incoterms</option>';
      
      if (selectedMode && incotermsOptions[selectedMode]) {
        incoTermsSelect.disabled = false;
        
        // Populate with appropriate options
        incotermsOptions[selectedMode].forEach(term => {
          const option = document.createElement('option');
          option.value = term;
          option.textContent = term;
          incoTermsSelect.appendChild(option);
        });
      } else {
        incoTermsSelect.disabled = true;
        incoTermsSelect.innerHTML = '<option value="">Select transport mode first</option>';
      }
    });

    function validateForm() {
      const requiredFields = ['readiness_date', 'address', 'origin', 'transport', 'inco_terms', 
                              'container_type', 'cartons_count', 'gross_weight', 'net_weight'];
      const errors = [];

      for (const fieldName of requiredFields) {
        const field = document.getElementById(fieldName);
        if (!field.value.trim()) {
          errors.push(`${field.previousElementSibling.textContent.replace(' *', '')} is required`);
          field.style.borderColor = '#ef4444';
        } else {
          field.style.borderColor = '#e2e8f0';
        }
      }

      // Validate positive numbers
      const grossWeight = document.getElementById('gross_weight').value;
      if (grossWeight && parseFloat(grossWeight) <= 0) {
        errors.push('Gross weight must be greater than 0');
        document.getElementById('gross_weight').style.borderColor = '#ef4444';
      }

      const netWeight = document.getElementById('net_weight').value;
      if (netWeight && parseFloat(netWeight) <= 0) {
        errors.push('Net weight must be greater than 0');
        document.getElementById('net_weight').style.borderColor = '#ef4444';
      }

      // Validate that net weight is less than or equal to gross weight
      if (grossWeight && netWeight) {
        if (parseFloat(netWeight) > parseFloat(grossWeight)) {
          errors.push('Net weight cannot be greater than gross weight');
          document.getElementById('net_weight').style.borderColor = '#ef4444';
        }
      }

      const cartonsCount = document.getElementById('cartons_count').value;
      if (cartonsCount && parseInt(cartonsCount) <= 0) {
        errors.push('Number of units must be greater than 0');
        document.getElementById('cartons_count').style.borderColor = '#ef4444';
      }

      // Validate future date for readiness
      const readinessDate = document.getElementById('readiness_date').value;
      if (readinessDate) {
        const selectedDate = new Date(readinessDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (selectedDate < today) {
          errors.push('Readiness date cannot be in the past');
          document.getElementById('readiness_date').style.borderColor = '#ef4444';
        }
      }

      return errors;
    }

    async function loadShipmentDetails() {
      const urlParams = new URLSearchParams(window.location.search);
      const shipmentId = urlParams.get('shipment_id');

      if (!shipmentId) {
        showMessage('Error: Shipment ID is missing from the URL. Please contact the sender for a correct link.', 'error');
        form.style.display = 'none';
        return;
      }

      shipmentIdInput.value = shipmentId;

      try {
        // Check if details already exist (one-time submission check)
        const { data: existingData, error: checkError } = await supabase
          .from('supplier_shipment_details')
          .select('*')
          .eq('shipment_id', shipmentId)
          .single();

        if (checkError && checkError.code !== 'PGRST116') {
          console.error('Error checking existing data:', checkError);
          showMessage('Error loading form. Please try again later.', 'error');
          return;
        }

        // If data already exists, show submitted state
        if (existingData) {
          showMessage('These shipment details have already been submitted. Thank you!', 'warning');
          form.classList.add('form-disabled');
          
          // Show the submitted overlay after a short delay
          setTimeout(() => {
            showSubmittedOverlay();
          }, 2000);
          
          return;
        }

        // Form is ready for first-time submission
        showMessage('Please fill in the shipment details below.', 'success');

      } catch (err) {
        console.error('Unexpected error:', err);
        showMessage('An error occurred while loading the form. Please try again.', 'error');
      }
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      
      // Validate form
      const validationErrors = validateForm();
      if (validationErrors.length > 0) {
        showMessage(`Please fix the following errors:<br>‚Ä¢ ${validationErrors.join('<br>‚Ä¢ ')}`, 'error');
        return;
      }

      // Show loading state
      const submitButton = document.getElementById('submitButton');
      const originalHTML = submitButton.innerHTML;
      submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting Details...';
      submitButton.disabled = true;

      try {
        const formData = new FormData(form);
        const details = {
          shipment_id: shipmentIdInput.value,
          readiness_date: formData.get('readiness_date') || null,
          address: formData.get('address') || null,
          origin: formData.get('origin') || null,
          transport: formData.get('transport') || null,
          inco_terms: formData.get('inco_terms') || null,
          container_type: formData.get('container_type') || null,
          cartons_count: formData.get('cartons_count') ? parseInt(formData.get('cartons_count')) : null,
          gross_weight: formData.get('gross_weight') ? parseFloat(formData.get('gross_weight')) : null,
          net_weight: formData.get('net_weight') ? parseFloat(formData.get('net_weight')) : null,
          length: formData.get('length') ? parseFloat(formData.get('length')) : null,
          width: formData.get('width') ? parseFloat(formData.get('width')) : null,
          height: formData.get('height') ? parseFloat(formData.get('height')) : null,
          details_received_date: new Date().toISOString().split('T')[0], // Auto-set to today
        };

        console.log('Submitting supplier shipment details:', details);

        // Use INSERT instead of UPSERT to prevent duplicate submissions
        const { error } = await supabase
          .from('supplier_shipment_details')
          .insert([details]);

        if (error) {
          console.error('Database error:', error);
          
          // Handle duplicate submission attempt
          if (error.code === '23505') { // Unique constraint violation
            showMessage('These details have already been submitted. Thank you!', 'warning');
            setTimeout(() => {
              showSubmittedOverlay();
            }, 2000);
          } else {
            showMessage(`Error saving details: ${error.message}`, 'error');
          }
        } else {
          showMessage('‚úÖ Shipment details submitted successfully! Thank you for your cooperation.', 'success');
          
          // Disable form after successful submission
          form.classList.add('form-disabled');
          
          // Show success overlay
          setTimeout(() => {
            showSubmittedOverlay();
          }, 2000);
        }
      } catch (err) {
        console.error('Unexpected error:', err);
        showMessage('An unexpected error occurred. Please try again later.', 'error');
      } finally {
        // Reset button state (if form is still active)
        if (!form.classList.contains('form-disabled')) {
          submitButton.innerHTML = originalHTML;
          submitButton.disabled = false;
        }
      }
    });

    // Initialize form when page loads
    window.addEventListener('load', loadShipmentDetails);
  </script>
</body>
</html>